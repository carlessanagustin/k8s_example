---
- hosts:
    - gluster
    - masters
  vars_files:
    - ./private.yml
  tasks:
    - name: deploy git code to instances
      tags:
        - git
      become: yes
      git:
        repo: "{{ item.git_repo }}"
        dest: "{{ item.git_dest }}"
        version: "{{ item.git_version | default('HEAD') }}"
        clone: yes
        update: yes
        accept_hostkey: yes
        force: yes
      with_items: "{{ repo_list }}"

    - name: customize deployment
      tags:
        - git
        - custom
      shell: "{{ item}}"
      args:
        chdir: /opt/k8s_example
      with_items:
        - "sudo sed -i 's|<glusterfs_ip>|{{ GSERVER_IP }}|g' ./pv-glusterfs/ep-glusterfs.yaml"

- hosts: masters
  tasks:
    - name: deploy k8s app
      tags: deploy
      shell: "{{ item}}"
      args:
        chdir: /opt/k8s_example
      with_items:
        ## 2 apps
        #- "make app_apply"
        # 1 apps + gluster
        - "make glusterv_apply"

- hosts: haproxy
  tasks:
    - name: TODO - add published port to haproxy.cfg
      when: False
      template:
        src: ../templates/haproxy.cfg.j2
        dest: /opt/k8s_example/lb-haproxy/haproxy.cfg
        owner: root
        group: root
        mode: 0644
        force: yes

    - name: TODO - start HA proxy server
      when: False
      args:
        chdir: /opt/k8s_example
      shell: "{{ item}}"
      with_items:
        - "make haproxy_up"
